# ICD — Протокол обмена ESP32↔UNO (I²C) — v0.2 (ПОЛНЫЙ, актуализировано под одометрию и фиксированный стеллаж)

## 0. Назначение и область применения
Документ описывает интерфейс и протокол обмена между **ESP32‑S3‑CAM** (мастер шины I²C) и **Arduino UNO** (ведомый `0x12`)
для автономного робота Robot‑based Manufacturing. Протокол покрывает:
- физический уровень и топологию шины,
- таблицу регистров (команды, телеметрию, конфигурацию),
- форматы данных, порядок байтов и единицы измерения,
- требования к таймингам/таймаутам и обработку ошибок,
- последовательности типовых операций (инициализация, движение, захват/установка банки),
- совместимость версий и расширяемость.

**Новое в v0.2 (по сравнению с v0.1):**
- Добавлены **одометрические счётчики** шасси: блок `ODOM (0x62)` — `odoL_cnt(i32)`, `odoR_cnt(i32)`.
- Добавлен **конфиг одометрии** `CFG_ODO (0x82)` — `cpr, gear_num, gear_den, wheel_diam_mm, track_mm`.
- Исключён модуль сканирования стеллажа из протокола (раскладка цветов фиксирована и хранится на ESP32 в NVS).

---

## 1. Ссылки и обозначения
- I²C‑bus specification and user manual, UM10204, Rev. 7 — NXP.
- mm — миллиметры; ms — миллисекунды; µs — микросекунды; mrad — миллирадианы.
- **LE** — little‑endian, младшие байты вперёд.
- `u8/i8, u16/i16, u32/i32` — беззнаковые/знаковые целые.
- PWM‑серво: формально 1000..2000 µs, нейтраль **1500 µs**.

---

## 2. Физический уровень и топология
- Шина **I²C 400 кГц**. **ESP32** — _master_, **UNO** — _slave_ по адресу **`0x12`**.
- Внешние **pull‑up 4.7–10 кОм к 3.3V** на SDA/SCL. Общая земля. Длина жгута ≤ 40 см.
- ESP32 опрашивает все блоки телеметрии периодом **20–50 мс**.
- Таймаут отсутствия корректного ответа от UNO **200 мс** → ESP32 выполняет `BRAKE` (всем каналам 1500 µs) и выставляет флаг аварии.

### 2.1. Поведение при ошибках шины
- NAK/timeout на чтении → повторить чтение блока **до 2 раз**; затем авария TIMEOUT.
- NAK на записи команды → повторить запись **1 раз**, затем авария I2C.
- UNO в состоянии `BRAKE` продолжает отвечать на чтение регистров.

---

## 3. Представление данных и выравнивание
- Все поля **LE**. Для многобайтовых полей сначала передаётся младшее слово/байт.
- Ширина регистров кратна **2 байтам**. Длины блоков указаны явно.
- Уровни лифта — в **мм**, позиции захвата — в **градусах** (по потенциометру — пересчёт в прошивке UNO).
- Одометрия публикуется в «тиках» энкодера после **4×** декодирования.

---

## 4. Таблица регистров (обзор)
**Команды (ESP32→UNO):**
- `DRIVE   0x00..0x07 (8)` — целевая (Vx, Vy, ω, t_ms)
- `ELEV    0x10..0x15 (6)` — лифт
- `GRIP    0x18..0x1B (4)` — захват
- `BRAKE   0x1C      (1)` — экстренная остановка (всем 1500 µs)
- `HOME    0x1D      (1)` — юстировка лифта/захвата
- `SEQ     0x1E      (1)` — применить конфиги (CFG_*)
- `APPLY   0x1F      (1)` — зафиксировать текущие уставки

**Телеметрия (UNO→ESP32):**
- `STATUS0 0x40..0x43 (4)` — состояние/флаги
- `STATUS1 0x44..0x47 (4)` — лифт/захват (в инженерных величинах)
- `LINES   0x48..0x4D (6)` — датчики линии
- `POWER   0x4E..0x51 (4)` — питание, MPS/E‑STOP
- `DRIVEFB 0x50..0x57 (8)` — обратная связь PWM по 4-м колёсам
- `AUXFB   0x58..0x5B (4)` — PWM лифта/захвата
- `SENS    0x5C..0x5F (4)` — сырые сенсоры (pot/энкодер лифта)
- `ODOM    0x62..0x69 (8)` — **одометрические счётчики i32**

**Конфигурация (rw; применяется по `SEQ`):**
- `CFG_LINE 0x70..0x71 (2)` — порог линии
- `CFG_LIFT 0x72..0x79 (8)` — геометрия лифта (мм↔тики)
- `CFG_GRIP 0x7A..0x81 (8)` — калибровка потенциометра/углов
- `CFG_ODO  0x82..0x8B (10)` — параметры одометрии

Диапазон адресов зарезервирован для расширений: `0x8C..0x9F`.

---

## 5. Команды (детально)

### 5.1 `DRIVE 0x00..0x07 (8 байт)`
```
i16 vx_mm_s   | i16 vy_mm_s   | i16 w_mrad_s | u16 t_ms
LE            | LE            | LE           | LE
```
- `vx_mm_s` — продольная скорость (+вперёд), `vy_mm_s` — поперечная (+вправо), `w_mrad_s` — угловая (+по часовой).
- `t_ms` — время актуальности команды. По истечении UNO либо удерживает последнее значение, либо «плавно» сводит к 1500 µs (настройка прошивки).
- Ограничения скоростей и смешивание (механум) выполняются на UNO.

### 5.2 `ELEV 0x10..0x15 (6)`
```
i16 h_mm | i16 v_mmps | u8 mode | u8 rsv
```
- Режимы: `mode=0` — позиция (ПИД по `h_mm`), `mode=1` — скорость (служебно).
- Диапазон валидности `h_mm` задаётся калибровкой (см. CFG_LIFT).

### 5.3 `GRIP 0x18..0x1B (4)`
```
u8 cmd | i16 arg_deg | u8 rsv
```
- `cmd`: `0=OPEN`, `1=CLOSE`, `2=POSE` (цель в градусах `arg_deg`).

### 5.4 `BRAKE 0x1C (1)`
```
u8 key = 0xA5
```
- Немедленно выставляет всем каналам 1500 µs. Состояние UNO → `BRAKE`.

### 5.5 `HOME 0x1D (1)`
```
u8 key = 0x5A
```
- Процедуры юстировки: поиск нулей лифта/захвата по датчикам и лимитам.

### 5.6 `SEQ 0x1E (1)` / `APPLY 0x1F (1)`
- `SEQ` — применить новые значения CFG\_* из регистров.
- `APPLY` — зафиксировать/сохранить уставки (опционально во внутреннюю EEPROM UNO; зависит от реализации).

---

## 6. Телеметрия (детально)

### 6.1 `STATUS0 0x40..0x43 (4)`
```
u8 state_id | u8 seq_ack | u16 err_flags
```
- `state_id ∈ {0:BOOT,1:IDLE,2:DRIVE,3:ELEV_MOVE,4:GRIP_MOVE,5:HOMING,6:BRAKE}`.
- `seq_ack` увеличивается при успешном `SEQ`.
- `err_flags` (битовая маска): `0x0001 TIMEOUT`, `0x0002 I2C`, `0x0004 ESTOP`, `0x0008 LIFT_LIMIT`, `0x0010 LIFT_ENC`, `0x0020 GRIP_POT`, `0x0040 LINE_FAIL`, `0x0080 ODO_FAIL`, ... (расширяемо).

### 6.2 `STATUS1 0x44..0x47 (4)`
```
i16 elev_mm | i16 grip_pos_deg
```
- Положение лифта/захвата в инженерных единицах.

### 6.3 `LINES 0x48..0x4D (6)`
```
u16 lineL_adc | u16 lineR_adc | u16 line_thr
```
- `line_thr=0` может означать «автопорог» по калибровке.

### 6.4 `POWER 0x4E..0x51 (4)`
```
u16 vbatt_mV | u8 mps | u8 estop
```
- `mps` — состояние силовой цепи моторов (MPS), `estop` — флаг E‑STOP.

### 6.5 `DRIVEFB 0x50..0x57 (8)`
```
u16 fl_us | u16 fr_us | u16 rl_us | u16 rr_us
```
- Фактические PWM (µs) на 4 MC29.

### 6.6 `AUXFB 0x58..0x5B (4)`
```
u16 lift_us | u16 grip_us
```
- PWM лифта и захвата (для диагностики насыщений).

### 6.7 `SENS 0x5C..0x5F (4)`
```
u16 pot_raw | i16 lift_enc_cnt
```
- Сырые показания потенциометра и счёт энкодера лифта (знаки/направление калибруются в прошивке).

### 6.8 `ODOM 0x62..0x69 (8)`
```
i32 odoL_cnt | i32 odoR_cnt   (LE: младшие слова вперёд)
```
- 32‑битовые счётчики тиков после 4× декодирования. ESP32 должен читать **разностно** (Δ к предыдущему чтению) чтобы избежать проблем переполнения.

---

## 7. Конфигурация (детально; применяется по `SEQ`)

### 7.1 `CFG_LINE 0x70..0x71 (2)`
```
u16 line_thr
```
- `0` — авто; иначе фиксированный порог.

### 7.2 `CFG_LIFT 0x72..0x79 (8)`
```
u16 enc_per_mm | i16 h1_mm | i16 h2_mm | i16 h3_mm
```
- Калибровка лифта и уровни полок.

### 7.3 `CFG_GRIP 0x7A..0x81 (8)`
```
u16 pot_min | u16 pot_max | i16 deg_min | i16 deg_max
```
- Линейная аппроксимация `pot_raw → deg` в прошивке UNO.

### 7.4 `CFG_ODO 0x82..0x8B (10)`
```
u16 cpr | u16 gear_num | u16 gear_den | u16 wheel_diam_mm | u16 track_mm
```
- Масштабирование на ESP32:
```
rev   = ticks / (cpr * gear_num/gear_den)
s_mm  = rev * π * wheel_diam_mm
θ_rad ≈ (sR_mm - sL_mm) / track_mm
```
- Направление каналов A/B должно быть согласовано: движение вперёд → `ΔL>0, ΔR>0`; поворот по часовой → `(ΔR − ΔL) > 0`.

---

## 8. Последовательности и тайминги

### 8.1 Инициализация
1) ESP32 проверяет присутствие `0x12` (скан шины).  
2) Читает `STATUS0`, проверяет отсутствие критических ошибок.  
3) Пишет `CFG_*` (если нужно) → `SEQ` и ждёт изменение `seq_ack`.  
4) Выполняет `HOME` (опционально) и ждёт переход в `IDLE`.

### 8.2 Движение по линии
1) Цикл: читаем `LINES`, вычисляем ошибку `(L−R)` на ESP32, формируем `DRIVE (vx, ω)`; `vy`=0.  
2) На перекрёстках — по шаблону маршрута A* выполняются повороты: `vy=0, vx≈0, ω≠0` с контролем по ODOM.

### 8.3 Подход и установка
1) `Pick`: подводка к конвейеру, захват банки, подъём.  
2) `GoPlace`: по `SHELF_MAP` выбираем (row,col), едем к узлу напротив столбца; микродокинг камерой по фасаду полки.  
3) `Place`: `ELEV(h=H[row])`, `GRIP(POSE/OPEN)` — контролируем отскок.

---

## 9. Обработка ошибок и восстановление
- TIMEOUT/I2C → `BRAKE`, повторный старт последовательности `Init` после команды оператора.  
- ESTOP/MPS=0 → удержание `BRAKE` до восстановления силовой шины.  
- LIFT_LIMIT/ENC → остановить лифт, выставить флаг; повторный `HOME` обязателен.  
- ODO_FAIL → игнорировать одометрию, перейти на «по линии» до ближайшего узла.

---

## 10. Совместимость и расширяемость
- Добавление `ODOM/CFG_ODO` **обратно совместимо**: старые мастеры могут игнорировать 0x62/0x82.  
- Диапазон `0x8C..0x9F` зарезервирован под будущие блоки (`CFG_PID`, `CFG_SERVO_LIMITS`, и т. п.).  
- Версия ICD публикуется в `STATUS0.err_flags` через маску «версии» (опционально) — TBD.

---

## 11. Примеры обмена (LE, байты в HEX)

### 11.1 Команда DRIVE: vx=300 мм/с, vy=0, ω=−150 мрад/с, t=200 мс
```
[W] 0x00:  2C 01   00 00   6A FF   C8 00
           ^^^^^   ^^^^^   ^^^^^   ^^^^^
           +300    +0      −150    200
```

### 11.2 Чтение ODOM
```
[R] 0x62:  10 27 00 00   F0 26 00 00
          L=0x00002710  R=0x000026F0 →  L=10000, R=9968 тиков
```

### 11.3 Настройка CFG_ODO и применение
```
[W] 0x82:  C0 00  |  10 00  |  01 00  |  A0 00  |  58 02
            cpr=192  gear_num=16  gear_den=1  wheel=160  track=600
[W] 0x1E:  01         // SEQ
[R] 0x40:  state=IDLE, seq_ack++
```

---

## 12. Изменения по сравнению с v0.1
- Добавлены `ODOM` и `CFG_ODO`.  
- Исключён обмен картой стеллажа; карта хранится на ESP32 (команды `SMAP` вне ICD).  
- Уточнены тайминги и обработка ошибок.

---

## 13. Контрольные вопросы при приёмке
- UNO стабильно отвечает на чтение всех блоков при 400 кГц?  
- При I²C‑timeout ESP32 уходит в `BRAKE` ≤ 200 мс?  
- ΔODO коррелирует с реально пройденным расстоянием и поворотом?  
- Порог линии реплицируется в телеметрии?  
- PWM обратной связи соответствует командным скоростям без насыщений?