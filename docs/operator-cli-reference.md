# Справочник CLI-команд ESP32

Документ описывает все команды протокола командной строки, которые прошивка ESP32 обрабатывает по UART и через WebSocket-транспорт (`ws://<ip>:81/ws/cli`).

## Использование

- **Через утилиту:** `rbm-operator command "<команда>" [опции]`. Для потоковых сценариев доступны специализированные подкоманды (`status`, `telemetry`, `smap`, `brake` и др.).
- **Непосредственно по каналу:** отправьте строку ASCII, завершённую `\n`. Ответ приходит тем же каналом; в большинстве случаев это одна строка `ключ=значение`. Для составных ответов используется несколько строк, их порядок фиксирован.
- **Wi‑Fi транспорт:** добавьте `--transport ws --ws-endpoint ws://esp32.local:81/ws/cli` к вызову CLI или задайте переменные окружения `OPERATOR_CONTROL_TRANSPORT=ws|auto` и `OPERATOR_WS_ENDPOINT` перед запуском backend.

### Соглашения о формате

- Все идентификаторы и ключи публикуются в нижнем регистре (кроме полей вида `CAMSTREAM=ON`).
- Числа всегда в десятичном виде, маски — в формате `0x****` (верхний регистр).
- Булевы значения кодируются `true`/`false`.
- При ошибках команда возвращает либо `*_error=<код>`, либо строку `ERR <причина>`.
- Если Arduino UNO недоступен, команды управления движением и часть диагностик возвращают коды `UNO_OFFLINE`/`UNO_MISSING`.

## 1. Диагностика и телеметрия

### STATUS

| Команда | Описание |
|---------|----------|
| `STATUS` | Возвращает сводку состояния ESP32 и UNO (лифт, захват, питание, линии, Wi‑Fi, камера). |

**Успешный ответ (UNO недоступен, пример с `wifi_ip=192.168.0.72`):**

```text
status_error=UNO_MISSING state_id=0 seq_ack=0 err_flags=0x0000 elev_mm=0 grip_deg=0 line_left=0 line_right=0 line_thr=0 vbatt_mV=0 mps=0 estop=0 drive_left=0 drive_right=0 drive_res1=0 drive_res2=0 aux_lift=0 aux_grip=0 grip_enc=0 lift_enc=0 odo_left=0 odo_right=0 wifi_connected=true wifi_ip=192.168.0.72 cam_streaming=false
```

При успешном соединении с UNO поле `status_error` отсутствует, а числовые значения отражают текущую телеметрию.

### CAMCFG (опрос)

| Команда | Описание |
|---------|----------|
| `CAMCFG ?` | Возвращает текущие параметры камеры и максимально поддерживаемое разрешение. Синонимы: `CAMCFG`, `CAMCFG INFO`. |

**Пример:**

```text
cam_resolution=QQVGA cam_quality=12 cam_max=UXGA
```

### CAMCFG (изменение)

| Команда | Описание |
|---------|----------|
| `CAMCFG resolution=<имя> [quality=<0-63>]` | Устанавливает разрешение и/или качество JPEG. Ключи `res`, `frame`, `q` — эквивалентны. |

**Успех:**

```text
cam_resolution=VGA cam_quality=20 cam_max=UXGA
```

**Ошибка (пример несоответствия разрешения):**

```text
camcfg_error=RESOLUTION
```

После изменения прошивка автоматически синхронизирует сенсор и, при необходимости, перезапускает поток MJPEG.

### CAMSTREAM

| Команда | Описание |
|---------|----------|
| `CAMSTREAM` | Выводит текущее состояние потока камеры (`ON`/`OFF`). |
| `CAMSTREAM ON` | Включает поток `/stream`. |
| `CAMSTREAM OFF` | Выключает поток и освобождает ресурсы. |

**Примеры ответов:**

```text
CAMSTREAM=OFF
CAMSTREAM=ON
CAMSTREAM=FAIL
```

`FAIL` возвращается, если запуск сервера не удался (например, Wi‑Fi не подключён).

### LOGS

| Команда | Описание |
|---------|----------|
| `LOGS [since=<seq>] [limit=<N>]` | Выгружает кольцевой буфер логов ESP32 начиная с последовательности `since` (0 — с самого начала). `limit` ограничивает число строк данных. |

**Пример с непустой выдачей:**

```text
10|[ESP32] Boot
11|[WiFi] Connected
logs_next=12 logs_count=2 logs_truncated=0
```

**Пустая выдача (нет новых строк):**

```text
logs_next=12 logs_count=0 logs_truncated=0
```

**Ошибка формата:**

```text
logs_error=SYNTAX
```

Поле `logs_next` указывает следующую ожидаемую последовательность. При использовании WebSocket CLI прошивка отправляет heartbeat с тем же значением (`"type":"heartbeat","logs_next":...`).

## 2. Управление Arduino UNO (CTRL)

Команды `CTRL` доступны только при активном подключении к UNO. Во всех примерах успешная операция завершается строкой `ctrl_<действие>=OK ...`. При отсутствии связи возвращается `ctrl_error=UNO_OFFLINE`.

### CTRL HOME

| Команда | Описание |
|---------|----------|
| `CTRL HOME` | Инициирует процедуру юстировки лифта и захвата. |

**Успех:** `ctrl_home=OK`

### CTRL DRIVE / MOVE

| Команда | Описание |
|---------|----------|
| `CTRL DRIVE vx=<мм/с> [vy=<мм/с>] [w=<мрад/с>] [t=<мс>]` | Линейное/угловое движение. Ключ `MOVE` эквивалентен. `t` по умолчанию 500 мс. |

**Пример запроса:** `CTRL DRIVE vx=200 w=0 t=1500`

**Ответ:**

```text
ctrl_drive=OK vx=200 vy=0 w=0 t=1500
```

Неверные аргументы → `ctrl_error=DRIVE_ARGS`. Ошибки шины I²C → `ctrl_error=I2C`.

### CTRL TURN

| Команда | Описание |
|---------|----------|
| `CTRL TURN dir=<left\|right> [t=<мс>]` | Поворот вокруг центра. Можно задавать `w=<мрад/с>`/`speed=<мрад/с>` вместо `dir`. |

**Пример:**

```text
ctrl_turn=OK w=400 t=600
```

Ошибки аргументов → `ctrl_error=TURN_ARGS`.

### CTRL ELEV / LIFT

| Команда | Описание |
|---------|----------|
| `CTRL ELEV h=<мм> [speed=<мм/с>] [mode=<0\|1>]` | Перемещение лифта. Синоним `CTRL LIFT`. |

**Ответ:**

```text
ctrl_elev=OK h=140 speed=150 mode=0
```

Без указания `h` → `ctrl_error=ELEV_ARGS`.

### CTRL GRIP

| Команда | Описание |
|---------|----------|
| `CTRL GRIP OPEN` | Открыть захват. |
| `CTRL GRIP CLOSE` | Закрыть захват. |
| `CTRL GRIP POSE arg=<градусы>` | Перейти в заданный угол. Ключи `pose`, `deg=<...>` также поддерживаются. |

**Пример:**

```text
ctrl_grip=OK cmd=2 arg=45
```

Ошибки аргументов → `ctrl_error=GRIP_ARGS`.

## 3. Команды I²C и автоматизации

### I2C SCAN

| Команда | Описание |
|---------|----------|
| `I2C` или `I2C SCAN` | Последовательно опрашивает адреса 0x01–0x7E, выводит найденные устройства и считает ошибки. |

**Пример (UNO обнаружен по адресу 0x12):**

```text
i2c_device=0x12
i2c_uno_found=true
i2c_scan_total=1
```

При ошибках передачи добавляется строка `i2c_error_addr=0x.. code=4`. Неизвестные подкоманды → `i2c_error=UNKNOWN_SUBCOMMAND`.

### START

| Команда | Описание |
|---------|----------|
| `START` | Запускает преднастроенную последовательность: конфигурация UNO (`SEQ`), остановка стрима камеры и переход автомата состояний в режим подбора. |

**Ответы:**

- `START=OK` — последовательность принята.
- `START=UNO_OFFLINE` — UNO не отвечает.
- `START=FAIL` — ошибка записи или UNO занят.

### BRAKE

| Команда | Описание |
|---------|----------|
| `BRAKE` | Немедленно останавливает приводы (1500 µs). |

**Ответы:** `BRAKE=OK` или `BRAKE=FAIL` (I²C-ошибка).

## 4. Карта полок (SMAP)

Команды реализованы в `shelf_map.cpp` и доступны независимо от состояния UNO.

| Команда | Описание |
|---------|----------|
| `SMAP GET` | Выводит текущую 3×3 матрицу цветов. |
| `SMAP SET "<строка>"` | Применяет новую карту. Формат: `R,G,B; Y,W,K; -,-,-`. Пробелы необязательны. |
| `SMAP SAVE` | Сохраняет карту в NVS. |
| `SMAP CLEAR` | Сбрасывает к значениям по умолчанию. |

**Примеры:**

```text
R,G,B; Y,W,K; -,-,-
OK
SAVED
RESET
```

Ошибочный формат при `SET` → `SMAP=ERR`.

## 5. Общие ошибки и поведение по умолчанию

- Незнакомая команда → `ERR UNKNOWN_CMD`.
- Таймаут блокировки CLI (занят мьютекс) → `ERR CLI_LOCK_TIMEOUT`.
- В режиме потокового CLI (Serial/WebSocket) каждое завершение команды сопровождается переводом строки; пустой ответ кодируется одинарным `\n`.

## 6. Полезные сочетания CLI

- **Телеметрия каждые 0.5 с:** `rbm-operator telemetry --interval 0.5`
- **Снимок состояния камеры перед изменением параметров:**

  ```bash
  rbm-operator command "CAMSTREAM" --transport ws
  rbm-operator command "CAMCFG ?" --transport ws
  ```

- **Выгрузка журнала при тестировании Wi‑Fi:** `rbm-operator command "LOGS since=0 limit=200" --transport ws`
- **Редактирование карты полок:**

  ```bash
  rbm-operator smap get
  rbm-operator smap set "R,G,B; Y,W,K; -,W,-"
  rbm-operator smap save
  ```

Все команды можно отправлять как через UART, так и по WebSocket; backend автоматически переключается между транспортами в режиме `auto`.
