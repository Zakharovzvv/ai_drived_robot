# Электрика и проводка робота (RBM) — v0.3

> Обновлено под фактические изменения: есть **Motor Power Switch (MPS)** — отключает **только моторы/MC29**, при этом **Arduino UNO и ESP32‑S3 питаются**; на подъёме — **квадратурный энкодер**, на захвате — **VEX‑потенциометр** (аналоговый). Комплект: **ESP32‑S3 WROOM + CAM (Freenove breakout)**, **Arduino UNO**, **VEX Motor 393 ×6**, **VEX Motor Controller 29 ×6**, **VEX Line Tracker 276‑2154 ×2**. Нет ToF/IMU и одометрии колёс.

---

## 1. Схема питания (логика)

```
[LiPo 2S 7.4V / VEX 7.2V]
       │
   [Предохранитель 20–30 A]
       │
   [E‑STOP + Motor Power Switch (разрыв силовой шины моторов)]
       │
   ┌──────┴───────────────┐
   │                       │
[MC29 ×6  (силовая 7–8.4V)]      [DC/DC 5V 5–10 A] ──→ UNO, датчики, LDO 3.3V → ESP32‑S3‑CAM
   │  │  │  │  │  │
   └─М─М─М─М─М─М──────────────  (Моторы 393)

*(При разомкнутом MPS моторы обесточены, но логика и камера активны.)*
```

**Замечания:**

* Общая «земля» для батареи, UNO и ESP32 обязательна (звёздная точка возле DC/DC).
* LC‑фильтры на входе DC/DC; электролиты 470–1000 µF у групп MC29.

---

## 2. VEX Motor Controller 29 — включение

* **Вход (к плате):** *White=SIG (Servo 50 Гц, 1–2 мс)*, *Red=+5V*, *Black=GND* (от UNO).
* **Выход (к мотору):** силовые 2‑проводные на 393.
* Управляем библиотекой **Servo.h**: `1500 µs` — стоп; `1000..2000 µs` — скорость/направление.

---

## 3. Таблица пинов (UNO, актуальная)

| Узел               | Контроллер | Пин UNO     | Примечание               |
| ------------------ | ---------- | ----------- | ------------------------ |
| Колесо FL          | MC29       | D3  (Servo) | механум                  |
| Колесо FR          | MC29       | D5  (Servo) |                          |
| Колесо RL          | MC29       | D6  (Servo) |                          |
| Колесо RR          | MC29       | D9  (Servo) |                          |
| Подъём             | MC29       | D10 (Servo) | замкнут по **энкодеру**  |
| Захват             | MC29       | D11 (Servo) | замкнут по потенциометру |
| **Lift Enc A**     | —          | D2 (INT0)   | квадратурный канал A     |
| **Lift Enc B**     | —          | D7          | квадратурный канал B     |
| **Grip Pot**       | —          | A3 (ADC)    | VEX Pot, 3‑проводной     |
| Line Tracker LEFT  | —          | A0 (ADC)    | аналоговый выход         |
| Line Tracker RIGHT | —          | A1 (ADC)    | аналоговый выход         |
| I²C SDA            | —          | A4          | связь с ESP32            |
| I²C SCL            | —          | A5          | связь с ESP32            |
| MPS/E‑STOP input   | —          | D13         | программный брейк        |

> Подключение энкодера лифта (квадратурный): *Red=+5V*, *Black=GND*, *White=A (D2)*, *Yellow=B (D7).*
> Подключение VEX‑потенциометра (захват): *Red=+5V*, *Black=GND*, *White=Analog OUT → A3.* Диапазон 0–5 В.

---

## 4. I²C ESP32↔UNO (уровни и разводка)

* **Роли:** ESP32‑S3 — **master**, UNO — **slave @0x12**.
* **Пуллап:** **внешние 4.7–10 кОм к 3.3V** (не к 5V). В UNO отключить внутренние подтяжки A4/A5.
* **Линии:** SDA↔SDA, SCL↔SCL, общий GND; длина ≤ 30–40 см.

---

## 5. Линия и калибровка

* Размещение датчиков: центральный + боковой (смещение 50–70 мм вправо), высота 3–5 мм, вылет 40–60 мм.
* Автокалибровка: измерить белое/чёрное → порог `≈ (min_black + max_white)/2`.
* Управление шасси: П‑регулятор по `(L - R)` + ограничение ω.

---

## 6. Маршрутизация жгутов

* Силовые (аккум→MPS→MC29): AWG 16–18; к моторам — AWG 18–20.
* Сигнальные (Servo/I²C/Line/Pot): AWG 24–26; вести отдельно от силовых, пересекать под 90°; предусмотреть кабель‑чейн на подъёме.

---

## 7. E‑STOP, Motor Power и защиты

* **MPS/E‑STOP** физически разрывает **только силовую** шину MC29.
* **Программный брейк:** вход D13 — при активации UNO выставляет всем каналам Servo `1500 µs` и игнорирует команды до сброса флага.
* **Предохранитель** 20–30 A у батареи; **TVS** на силе; **LC** на DC/DC.

---

## 8. Пошаговый smoke‑test

1. Проверить полярность и работу MPS: при разомкнутом MPS моторы не стартуют, но UNO/ESP32 доступны по USB и I²C.
2. I²C‑сканер на ESP32 видит `0x12`.
3. Подать сигналы `1500 µs` на все 6 каналов — убедиться в «нуле».
4. Проверить энкодер лифта (каналы A/B на D2/D7) и потенциометр захвата (A3: 0–1023).
5. Калибровать пороги линии; проехать метр по линии.
6. Homing лифта (по упору), проверка preset уровней; проверка захвата по пресетам.

---

## 9. Приложение A — распиновка MC29/датчиков (памятка)

* **MC29 (к плате):** *White=SIG, Red=+5V, Black=GND*; (к мотору: красный/чёрный силовые).
* **Line Tracker 276‑2154:** *Red=+5V, Black=GND, White=Analog OUT*. Диапазон напряжений зависит от отражения.
* **Энкодер квадратурный VEX:** *Red=+5V, Black=GND, White/Yellow = A/B каналы*. Подключать к цифровым пинам UNO.

---
