# Электрика и проводка робота (RBM) — v0.5 (ПОЛНАЯ РЕДАКЦИЯ)

## Changelog v0.5
- Обновлены силовые цепи под **2× ведущих мотора** шасси вместо четырёх.
- Перенастроена распиновка: освободившиеся каналы задних колёс задействованы под **энкодер захвата (A/B)**.
- Уточнено крепление камеры: **правая передняя стойка**, высота ~200 мм от пола, жгут выведен вдоль стойки.

---

## 1. Топология питания
```
[Аккумулятор 7.2–7.4V] → [Предохранитель 20–30 A] → [MPS/E‑STOP] → [MC29 ×4] → [Двигатели 393]
                                              └→ [DC/DC 5V 5–10A] → [UNO + датчики] → [LDO 3.3V] → [ESP32‑S3‑CAM]
```
- **Общая GND** в «звезду» у DC/DC.  
- **LC‑фильтр** на вход DC/DC; **электролиты 470–1000 µF** на шине MC29.  
- Рекомендуемые разъёмы: XT60/XT30 для силовой, JST‑XH/PH для сигнальной.  
- **TVS‑диод** на силовой шине (обрыв/индуктивный выброс).

### 1.1 Бюджет тока (оценка)
- 2× 393 (ход) до 2×3 A сред., пики 2×6 A; лифт/захват 2×2–4 A пики.  
- DC/DC 5–10 A достаточно для UNO+датчики+серво (при необходимости) с запасом.  
- ESP32‑S3‑CAM до 0.25–0.35 A @3.3V (с Wi‑Fi).

---

## 2. MPS/E‑STOP
- **Разрывает только силовую линию** питания MC29, не отключая логику.  
- Вход `MPS/E‑STOP input` на UNO (D13) дублирует состояние: при размыкании → **BRAKE** (1500 µs всем каналам) и запрет команд до восстановления.

---

## 3. I²C (ESP32 master ↔ UNO slave `0x12`)
- Частота **400 кГц**, подтяжки **4.7–10 кОм к 3.3V** (не к 5V!).  
- Длина жгута ≤ 40 см; крутить пары; разводить вдали от силовых тросов.  
- Рекомендовано тестировать `i2c scanner` на ESP32 до ввода в строй.  
- Таймаут мастера **200 мс** → команда `BRAKE` и флаг TIMEOUT.

---

## 4. Распиновка контроллеров

### 4.1 Arduino UNO (под одометрию)

| Узел                     | Контроллер | Пин UNO     | Примечание                                   |
|-------------------------|------------|-------------|----------------------------------------------|
| Колесо **FL**           | MC29       | **D4**      | *перенос с D3 (освобождаем INT1)*            |
| Колесо FR               | MC29       | D5          |                                              |
| Подъём                  | MC29       | D10         | ПИД по энкодеру                              |
| Захват                  | MC29       | D11         | Позиционный привод                           |
| **Lift Enc A/B**        | —          | D2 / D7     | Квадратура лифта                             |
| **ODO Left A/B**        | —          | **D3 / D8** | Лев. A=**D3(INT1)**, B=D8                    |
| **ODO Right A/B**       | —          | **D12 / A2**| Прав. A=D12(PCINT), B=A2                     |
| **Grip Enc A/B**        | —          | **D6 / D9** | Квадратура захвата (бывшие каналы RL/RR)     |
| Line Tracker LEFT       | —          | A0          | Аналог                                       |
| Line Tracker RIGHT      | —          | A1          | Аналог                                       |
| (резерв)                | —          | A3          | Свободен, можно задействовать под сенсор     |
| I²C SDA / SCL           | —          | A4 / A5     | ESP32 master ↔ UNO slave `0x12`              |
| MPS/E‑STOP input        | —          | D13         | Программный брейк                            |

### 4.2 ESP32‑S3‑CAM (интерфейсы и связи с UNO)

| Функция / Сигнал         | Пин ESP32 | Направление | Соединение                                    |
|--------------------------|-----------|-------------|-----------------------------------------------|
| I²C SDA                  | GPIO8     | bidir       | ↔ UNO A4 (SDA), общая подтяжка 4.7–10 кОм к 3.3V |
| I²C SCL                  | GPIO9     | bidir       | ↔ UNO A5 (SCL), общая подтяжка 4.7–10 кОм к 3.3V |
| 3V3                      | 3V3       | out         | Питание ESP32 от LDO 3.3V, не подключать к 5V     |
| GND                      | GND       | —           | Общая земля с UNO и силовой «звездой»             |
| UART0 TX (CLI/лог)       | GPIO43    | out         | Встроенный USB‑UART → ПК (не подключать к UNO)    |
| UART0 RX (CLI/лог)       | GPIO44    | in          | Встроенный USB‑UART ← ПК                         |
| RST/EN                   | EN        | in          | Через кнопку/программатор; оставляем свободным    |
| BOOT                     | GPIO0     | in          | Только для прошивки (замыкание на GND при boot)   |

> Для стабильной работы I²C необходима общая земля и подтяжки к 3.3V на обеих линиях. Подключение сигнала 5V к пинам ESP32 запрещено.

**VEX 276‑2156 — распиновка кабеля:** `Red=+5V`, `Black=GND`, `White=A`, `Yellow=B`.  
**Полярность:** движение **вперёд** → оба счётчика увеличиваются; поворот по часовой → `(ΔR − ΔL) > 0`.

---

## 5. Камера ESP32‑S3‑CAM — питание и монтаж

- Питание 3.3V от LDO (с запасом по току 500 mA), «земля» общая.  
- Плата на 4 нейлоновых стойках 10–12 мм; **диэлектрическая** площадка; **козырёк** от бликов.  
- Монтаж: правая передняя стойка рамы, высота ≈200 мм от пола, вылет 40–60 мм, наклон 12–15° вниз.
- Жгут камеры фиксируется вдоль стойки, отводим вправо от силовых трасс.

---

## 6. Датчики линии 276‑2154

- Аналоговые выходы на A0/A1; порог берётся из `CFG_LINE` (или автокалибровка на старте).  
- Высота 3–5 мм над полем; чёрная линия даёт падение АЦП ≥ 400 пунктов относительно белого.

---

## 7. Одометрия VEX 276‑2156

- Подключение: `+5V/GND/A/B`. Канал **A** — на **D3(INT1)** для левого борта; **B** — на **D8**. Правый: **A→D12 (PCINT)**, **B→A2**.
- Счёт **4×** в прошивке UNO (по фронтам A и B). Публикация 32‑бит суммарных счётчиков в блоке `ODOM`.
- Масштабирование координат выполняется на ESP32 по `CFG_ODO`.  

---

## 8. Жгуты, маркировка, EMC

- Силовые — AWG16–18; моторам — AWG18–20; сигнальные — AWG24–26.  
- Силовые и I²C/энкодеры разводить **раздельно**; пересечения под 90°.  
- Стяжки + бирки (Label ID) для каждого кабеля; слабые «сервисные петли» у подвижных узлов.  
- Ферритовые кольца/клипсы рядом с MC29 и на кабелях энкодеров при необходимости.

---

## 9. Пошаговая сборка

1) Смонтировать силовую шину: аккумулятор → предохранитель → MPS/E‑STOP → MC29.  
2) Проложить DC/DC 5V, завести «звезду» GND.  
3) Распределить сигнальные жгуты (I²C, энкодеры, линия, пот).  
4) Подключить MC29 к UNO по указанным пинам (Servo).  
5) Подключить энкодеры лифта/ODO/захвата, датчики линии.  
6) Установить ESP32‑S3‑CAM, подать 3.3V, проверить видеопоток/CLI.  
7) Повесить бирки и сделать фото‑фиксацию трассировки.

---

## 10. Проверки мультиметром (до включения логики)

- Полярность на MC29 и DC/DC. Сопротивление GND↔GND между узлами ≈ 0 Ω.  
- Отсутствие «земляных петель» (дублированных путей) — визуально.  
- Замер плеча DC/DC под нагрузкой (пульсации ≤ 50 мВ).

---

## 11. Smoke‑test (под питанием, MPS=OFF)

1) UNO и ESP32 включаются; I²C‑сканер ESP32 видит `0x12`.  
2) Все 4 Servo‑канала (шасси Л/П + лифт + захват) ≈ 1500 µs; на MC29 — «ноль».  
3) Лифт: вращение вручную — счётчик энкодера меняется в обе стороны.  
4) ОDO: вращение ведущих передних колёс вручную — счётчики растут/убывают ожидаемо.  
5) Линия: АЦП на A0/A1 различает чёрное/белое ≥ 400 единиц.  
6) Захват: вращение в ручном режиме → импульсы на D6/D9 (осциллограф/логический анализатор) без пропусков.

---

## 12. Ввод в эксплуатацию

1) Закрыть MPS → кратковременный прогон `DRIVE` с малыми значениями (проверить направления).  
2) Выполнить `HOME` лифта/захвата.  
3) Установить `CFG_ODO`, `CFG_LINE`, `CFG_LIFT`, `CFG_GRIP`; отправить `SEQ`.  
4) Настроить `SHELF_MAP` (если отличается от дефолта) и `SMAP save`.  
5) Проверить докинг по камере и точность остановок.

---

## 13. Обслуживание и запасные части

- Запас: 1× MC29, 1× 393, набор стоек/уголков, провода AWG18/24, ферриты, предохранители.  
- Раз в смену: визуальная проверка жгутов, крепежа камеры, ослабления клемм.  
- Раз в неделю: проверка пульсаций 5V и температур MC29.

---

## 14. Ссылки на смежные документы

- **Архитектура v0.6** — роли, поведение, CV, калибровки.  
- **ICD v0.3** — таблица регистров, одометрия/конфиги, тайминги/ошибки.
