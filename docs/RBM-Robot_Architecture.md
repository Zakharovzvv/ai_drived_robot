# Архитектура Робота для Robot‑based Manufacturing — v0.5 (ПОЛНАЯ РЕДАКЦИЯ)

## Changelog v0.5
- ДОБАВЛЕНО: 2× **VEX 276‑2156 Optical Shaft Encoder** на шасси (левый/правый борта) — одометрия.
- УТОЧНЕНО: колёса объединены **через редуктор** (учёт `gear_num/gear_den` в масштабировании).
- ЗАКРЕПЛЕНО: **камера ESP32‑S3‑CAM — низко на жёсткой раме**, по центру перед захватом (вылет 40–60 мм, наклон 12–15° вниз).
- УПРОЩЕНО: раскладка цветов стеллажа заранее **фиксирована** → **нет сканирования полок**, добавлен `SHELF_MAP 3×3` (NVS, `SMAP set/get/save/clear`).
- ДОКУМЕНТИРОВАНО: роли узлов, поведение (BT), навигация, калибровки, приёмочные критерии, риски/смягчения.

---

## 1. Контекст и цели
Соревнование «Robot‑based Manufacturing»: робот должен **переносить цилиндры** («банки») с конвейера и размещать их **вертикально** в ячейки **стеллажа 3×3** согласно **предзаданной** цветовой карте. Поле разлиновано чёрными линиями (шаг ~500 мм), есть перекрёстки. Робот работает **полностью автономно**, управляется ИИ‑модулем (ESP32‑S3) через MCU‑исполнитель (UNO).

### 1.1 Цели архитектуры
- Надёжно проходить цикл **Pick → Place** для всех шести цветов при переменной освещённости.
- Обеспечить **стабильную геометрию** восприятия (камера на жёсткой раме).
- Комбинировать **следование по линии** (надежность) и **одометрию** (точные манёвры без линии).
- Минимизировать сложность: без нейросетей; CV — простое и объяснимое (HSV, границы, масштаб px→мм).

---

## 2. Аппаратная архитектура (обзор)
```
        [ ESP32-S3-CAM ]
              | I²C 400кГц (SDA/SCL @3.3V, pull-up 4.7–10k) + UART/CLI
        [ Arduino UNO ]  — исполнитель: моторы/датчики/охранные контуры
        /    |      \
  [MC29×4] [MC29]  [MC29]   ← колёса×4, подъём, захват
     |                 
  VEX 393 (механум) — лев/прав борта через РЕДУКТОРЫ
Sensors (UNO): Line L/R (аналог), Lift Enc A/B, Grip Pot, ODO L/R (A/B)
Sensors (ESP32): камера (цвет банки, докинг по фасаду)
Power: LiPo 2S → MPS/E-STOP → MC29; DC/DC 5V → UNO → LDO 3.3V → ESP32
```

### 2.1 Роли вычислительных узлов
- **ESP32‑S3‑CAM (мастер):** CV (`vision_color`, `vision_dock`), планирование A*, поведение (BT), `SHELF_MAP`, конфиги (`CFG_*`), лог/телеметрия, I²C‑мастер.
- **Arduino UNO:** привода (механум микширование), ПИД‑лифт, позиционный захват, счётчики энкодеров (лифт/ODO), line‑follow, безопасность, I²C‑slave.

### 2.2 Исполнительные механизмы
- **Шасси:** 4× VEX 393 → MC29×4, механум. Борта объединены редукторами.
- **Лифт:** 1× 393 → MC29, квадратура A/B на валу.
- **Захват:** 1× 393 → MC29, VEX‑потенциометр (позиционный режим).

### 2.3 Датчики
- **Линия:** 2× VEX 276‑2154 (аналог, A0/A1). Высота 3–5 мм над полем.
- **Одометрия:** 2× VEX 276‑2156 на валах редукторов бортов (лев/прав).
- **Лифт:** энкодер (A/B). **Захват:** потенциометр.
- **Камера:** ESP32‑S3‑CAM (OV2640), фикс. фокус под 0.25–0.45 м; AE/AWB фиксированно в бою.

---

## 3. Функции ПО (детально)

### 3.1 ESP32‑S3 (высокоуровневое управление)
- `vision_color`: выделение цилиндра в кадре, усреднение HSV в маске; классификация по порогам (`R,G,B,Y,W,K`). Пороговые диапазоны настраиваются; авто‑баланс выключен для повторяемости.
- `vision_dock`: оценка смещения по фасаду полки/конвейера — поиск двух вертикальных границ (градиент/Canny), центрирование, оценка расстояния по масштабу (px→мм).
- `planner`: граф из узлов (перекрёстки) с шагом ~0.5 м; на рёбрах — line‑follow; при отсутствии линии — DR по одометрии.
- `bt`: детерминированное поведение: `Init → Pick → GoPlace(color) → Place → loop`.
- `shelf_map`: фиксированный 3×3; CLI `SMAP get/set/save/clear`; хранение в NVS.
- `i2c_link`: реализация ICD (команды/телеметрия/конфиг), защита по таймауту 200 мс → `BRAKE`.

### 3.2 Arduino UNO (низкоуровневое управление)
- `drive_meca`: преобразование (Vx,Vy,ω) → 4× Servo‑PWM (1000..2000 µs), S‑кривые разгона/торможения.
- `lift_ctrl`: ПИД по энкодеру; профили скорости; лимиты хода; homing.
- `grip_ctrl`: позиционный по потенциометру; OPEN/CLOSE/POSE; обнаружение «недобора» (банка схвачена).
- `line_follow`: П‑регулятор по `(L−R)` с ограничением `ω`.
- `odo_read`: квардратура 2× (лев/прав), 32‑бит счётчики; публикация в `ODOM`.
- `safety`: мониторинг E‑STOP/MPS; программный `BRAKE` по таймауту/ошибке; фильтры дребезга.

---

## 4. Навигация и локализация

### 4.1 Граф и планирование
- Узлы — перекрёстки линий; рёбра — участки между узлами. Планирование A* по статической карте поля.
- Окончательная подводка (докинг) — по камере (вертикальные грани фасада).

### 4.2 Следование по линии
- Ошибка `e = (L−R)` (нормированная), управляющее `ω = Kp*e`, ограничение |ω|≤ω_max.
- При неоднозначности (перекрёсток): сверка с целевым направлением из A*; на разворотах — опора на одометрию поворота.

### 4.3 Dead‑Reckoning по одометрии (276‑2156)
- Счётчики `odoL_cnt/odoR_cnt` (тики, 4×). Масштабирование на ESP32 по `CFG_ODO`:
  - `rev = ticks / (cpr * gear_num/gear_den)`  
  - `s_mm = rev * π * wheel_diam_mm`  
  - `θ = (sR − sL)/track_mm`
- Боковая компонента у механумов без IMU недонаблюдаема → избегаем длинных участков без линий; при первой возможности возвращаемся на линию.

### 4.4 Релокализация
- На каждом перекрёстке сбрасываем интегрированную ошибку DR → «подхватываем» референс по линии.

---

## 5. Восприятие (CV)

### 5.1 Цвет банки (конвейер)
- ROI по нижней части кадра; морфология для подавления шумов; HSV‑пороговая классификация.
- Для «белого»/«чёрного» используем яркостный канал V и насыщенность S.
- Минимальный диаметр в пикселях задаёт отбрасывание ложных мелких пятен.

### 5.2 Докинг по фасаду полки
- Поиск двух устойчивых вертикальных границ; оценка бокового смещения и угла разворота.
- Шкала px→мм — по известной ширине проёма; калибруется один раз.

---

## 6. Поведение (BT) детально
1) **Init**: homing лифта/захвата; авто‑порог линии; камера фикс AE/AWB; загрузка `SHELF_MAP` из NVS; проверка I²C.
2) **Pick**: A* к узлу «конвейер» → линейный докинг → классификация цвета → `GRIP(CLOSE)` → `ELEV` до уровня переноски.
3) **GoPlace(color)**: по `SHELF_MAP` выбираем (row,col), строим маршрут; на финальном ребре — докинг по фасаду.
4) **Place**: `ELEV(H[row])` → `GRIP(OPEN/POSE)` → контроль отскока → отъезд на безопасное расстояние.
5) Цикл до завершения времени.

---

## 7. SHELF_MAP (фиксированная карта 3×3)
- Индексация: `row=0..2` (низ..верх), `col=0..2` (слева→вправо, как видит робот).
- Представление: перечисление `Color={R,G,B,Y,W,K,-}` (`-`=пусто).
- Хранение: NVS на ESP32 (ключ `shelf_map`), формат — строка `B,W,Y; G,B,R; -,-,-`.
- CLI: `SMAP get|set|save|clear`. При `clear` — дефолт из прошивки.

---

## 8. Калибровки и параметры
- **CFG_ODO**: `cpr`, `gear_num/gear_den`, `wheel_diam_mm`, `track_mm` — задаёт масштаб mm/рад.
- **Линия**: `line_thr (0=auto)`, `Kp_line`, `ω_max`. Автокалибровка при `Init`.
- **Лифт**: `enc_per_mm`, `H1/H2/H3`, предельные `min/max`.
- **Захват**: `pot_min/max`, `deg_min/max` (линейная аппроксимация).
- **Камера**: ROI, пороги HSV по каждому цвету; фокус на 0.25–0.45 м; наклон 12–15° вниз.

---

## 9. Безопасность
- **MPS/E‑STOP** разрывает **силовую шину** MC29; логика остаётся запитанной.
- **Таймаут I²C** 200 мс → `BRAKE`.
- **Лимиты лифта** по энкодеру; аварийные остановы при достижении пределов.
- **Недобор захвата** → повторная попытка (до 2 раз), затем флаг ошибки.

---

## 10. Приёмочные критерии и тесты
- **Линия (прямая 2 м):** средняя боковая ошибка ≤ 20 мм при 0.4 м/с.
- **Поворот 90°:** ошибка ≤ 5° (по одометрии + визуально).
- **Цвет (3 уровня света):** точность классификации ≥ 99% на наборах тренировки; на поле — не менее 95%.
- **Докинг:** остаточный боковой сдвиг ≤ 10 мм; остаточный угол ≤ 2°.
- **Установка:** попадание в ячейку всех 3 уровней без касания покрытия.

---

## 11. Сервис и логирование
- ESP32 UART‑CLI: `SMAP`, `CFG_ODO`, `CFG_LINE`, `status`, `i2c scan`, `dock dbg`.
- Логирование ключевых событий: взятие/постановка, ошибки, таймауты.

---

## 12. Риски и смягчения
- **Скользкая поверхность / проскальзывание механумов** → возврат на линию как можно чаще; докинг по камере.
- **Пересвет/тени** → козырёк камеры; отключённый авто‑баланс; пороги HSV с запасом.
- **Шумы энкодеров** → экранирование жгутов, развязка питания, чтение по прерываниям.

---

## 13. Материалы и пины (кратко)
- ESP32‑S3‑CAM, Arduino UNO, 6× VEX 393 + 6× MC29, 2× Line Tracker 276‑2154, 2× ODO 276‑2156, энкодер лифта, VEX Pot.
- Пиновка подробно — см. документ «Электрика v0.4».

---

## 14. Интерфейсы
- Полный протокол I²C — см. документ «ICD v0.2» (ODOM/CFG_ODO включены).

---

## 15. Ввод в эксплуатацию (шорт‑чек)
1) Провода/жгуты/полярность/пуллап I²C.  
2) I²C‑сканер ESP32 видит `0x12`.  
3) Smoke‑test исполнительных каналов (1500 µs).  
4) Калибровка линии/HSV/докинга.  
5) Настройка `SHELF_MAP` и сохранение в NVS.