# Системная архитектура робота (RBM) — v0.4

> Цель: полностью автономный робот для «Robot‑Based Manufacturing» на базе: **ESP32‑S3 WROOM + CAM**, **Arduino UNO**, **VEX 2‑Wire Motor 393 ×6**, **VEX Motor Controller 29 ×6**, **VEX Line Tracker 276‑2154 ×2**.
> **Нет:** ToF‑дальномера, IMU, одометрии колёс. **Есть:** **энкодер на подъёме (квадратурный)** и **VEX‑потенциометр на захвате (аналоговый)**.

---

## 1. Концепт распределения ролей

* **ESP32‑S3‑CAM (ИИ‑ядро):** зрение (линия/перекрёстки, распознавание цвета цилиндров и ячеек стеллажа), построение узловой карты поля, планирование (A*), поведение (Behavior Tree), команды на UNO.
* **Arduino UNO (исполнитель):** низкоуровневые петли — 6 моторов через MC29, подъём (ПИД по энкодеру), захват (ПИД/пресеты по потенциометру), чтение 2× Line Tracker, безопасность (E‑STOP/таймауты), телеметрия.
* **Связь ESP32↔UNO:** **I²C** (ESP32 master → UNO slave @0x12). USB‑Serial UNO свободен для отладки.

---

## 2. Механика и привода

* **Шасси:** 4× VEX 393 на механум‑колёса (Vx/Vy/ω). Без одометрии — держимся линии и узлов, финальная юстировка по камере.
* **Подъём:** 1× VEX 393, **квадратурный энкодер** на валу → точные уровни H1/H2/H3.
* **Захват:** 1× VEX 393, **VEX‑потенциометр** на валу → позиционный контроль, детект захвата по «недобору» хода.
* **Драйверы:** **MC29 ×6** — по одному на каждый мотор (4 колеса + подъём + захват). Управление форматом Servo 50 Гц (1–2 мс, 1.5 мс — стоп).

---

## 3. Датчики и ориентирование

* **Линия:** **VEX Line Tracker 276‑2154 ×2** (аналог). Размещение: один по центру, второй — смещён на 50–70 мм (вправо), вылет вперёд 40–60 мм, высота 3–5 мм.
* **Камера (ESP32‑S3‑CAM):** подтверждение линии/перекрёстков; распознавание **цвета цилиндров** и **цвета ячеек** (HSV + лёгкая ML‑валидация); оценка расстояния при стыковке по масштабу объекта (px→мм).
* **Подъём:** энкодер A/B (квадратурный) — замкнутый контур, профили S‑кривых.
* **Захват:** VEX‑потенциометр (аналог) — замкнутый контур положения/усилие по косвенным признакам.

---

## 4. Электрическая логика и пины (UNO)

* **Связь:** I²C — ESP32 (SCL/SDA) ↔ UNO (A5/A4), внешние pull‑up 4.7–10 кОм к **3.3V**, общий GND.
* **MC29 ×6 (сигналы Servo):**

  * Колёса: **D3 (FL)**, **D5 (FR)**, **D6 (RL)**, **D9 (RR)**
  * Подъём: **D10**
  * Захват: **D11**
* **Датчики:**

  * **Lift Enc A/B:** **D2 (INT0)** / **D7**
  * **Grip Pot:** **A3 (ADC)**
  * **Line Trackers:** **A0** (Left), **A1** (Right)
  * **I²C:** **A4 (SDA)**, **A5 (SCL)**
  * **E‑STOP input:** **D13** (дублирует аппаратный грибок)

> Питание: 2S LiPo 7.4 В → MC29; DC/DC 5 В 5–10 А → UNO/датчики; LDO 3.3 В → ESP32‑S3‑CAM. Общий GND; LC‑фильтры и предохранитель у батареи.

---

## 5. Программная архитектура

### 5.1 ESP32‑S3 (перцепция, планирование, поведение)

* `vision_line` — ROI→бинаризация→морфология→центроид/угол (линия/перекрёстки).
* `vision_color` — HSV‑порог + мини‑классификатор TFLM (цвет цилиндра/ячейки).
* `mapper` — узловая карта поля (пересечения), разметка: конвейер/стеллаж/транспортная зона.
* `planner` — A* по узлам, примитивы движения (vx, vy, ω, t).
* `bt` — Behavior Tree: Init→ScanShelf→Pick→Place→Loop→Finish.
* `i2c_link` — регистровый протокол к UNO (20–50 мс цикл, таймаут 200 мс → BRAKE).

### 5.2 Arduino UNO (реалтайм‑исполнитель)

* `line_reader` — 2× Line Tracker (автокалибровка порога).
* `drive_mecanum` — (Vx,Vy,ω) → 4 Servo‑канала MC29 + S‑кривая ускорений.
* `elevator` — ПИД по энкодеру (homing, H1/H2/H3, удержание уровня).
* `gripper` — OPEN/CLOSE/POSE по **потенциометру** (A3), лимиты скорости, детект захвата по «недобору».
* `safety` — E‑STOP/таймаут, аварийный BRAKE (1500 мкс всем каналам), диапазоны Servo.
* `telemetry` — позиции/датчики/напряжение/флаги ошибок.

---

## 6. Протокол ESP32↔UNO (I²C, регистровая шина)

**Адрес UNO:** `0x12`.

**Команды (ESP32→UNO):**

* `DRIVE   0x00..0x07` — int16 `Vx`, `Vy`, `Wz`, uint16 `Tms`
* `ELEV    0x10..0x15` — int16 `pos_mm`, uint16 `vmax`, `amax`
* `GRIP    0x18..0x1B` — uint8 `mode` (0=OPEN,1=CLOSE,2=POSE); int16 `pose_deg`
* `BRAKE   0x1C`       — uint8 `on`
* `HOME    0x1D`       — uint8 `mask` (бит0=лифт, бит1=захват)

**Телеметрия (UNO→ESP32):**

* `STATUS  0x40..` — `elev_mm`, `grip_pos_deg` (из A3), `lineL`, `lineR`, `vbatt_mV`, `err_flags`
* `DRIVEFB 0x50..` — текущие цели для 4 каналов колёс (для отладки)

**Тайминги:** период цикла 20–50 мс; таймаут связи 200 мс → аварийный BRAKE.

---

## 7. Навигация и докинг (без одометрии)

* **Следование по линии:** П‑регулятор по разности (Left‑Right) + ограничение ω. На перекрёстках — стоп, подтверждение камерой, выбор направления по плану.
* **Учёт пути:** счёт узлов (пересечений). Внутри ребра — по времени/скорости, финальная юстировка камерой.
* **Докинг к стеллажу/конвейеру:** узел перед объектом → поворот → оценка расстояния по камере → подъезд «на размер» → боковая коррекция (механум) → действие (Pick/Place).

---

## 8. Поведенческая схема (BT)

```
Root
 ├─ Init (Homing лифта/захвата; автокалибровка линии; камера: экспозиция)
 ├─ ScanShelfColors (карта «ячейка→цвет»)
 └─ RepeatUntil(TimeUp or AllPlaced)
     ├─ SelectItem (ближайший/ценный)
     ├─ GoToConveyor → Dock → Pick (GRIP CLOSE, verify by pot)
     ├─ PlanToShelf(color) → FollowLine/A* → Dock
     └─ Place (ELEV level → Align → GRIP OPEN → Verify vertical)
```

---

## 9. Безопасность

* **Аппаратно:** E‑STOP на силовой шине, предохранитель у батареи, разделение «грязной/чистой» земли, LC‑фильтры.
* **Программно:** watchdog команд, лимиты скоростей/токов через PWM, аварийный BRAKE при таймаутах/ошибках датчиков.

---

## 10. Калибровка перед стартом

1. Homing лифта (энкодер) и захвата (нулевая позиция по потенциометру).
2. Автопорог линии (чёрное/белое).
3. Камера: баланс белого/экспозиция + калибровка px→мм.
4. Скан цветов ячеек стеллажа (кэш «ячейка→цвет»).
5. Тестовый цикл Pick&Place на ближайшей ячейке.

---

## 11. План реализации (минимальные итерации)

* **I1 — Электрика:** MC29×6, Line Tracker×2, E‑STOP, общие 5V/GND, pull‑up I²C к 3.3V.
* **I2 — UNO:** line‑follow, лифт по энкодеру, захват по потенциометру, I²C‑протокол, `Servo.h` на 6 каналов.
* **I3 — ESP32:** цвет цилиндров/ячеек, узловая карта, A*, BT.
* **I4 — Докинг камерой:** калибровка px→мм, сценарий Pick/Place без ToF.
* **I5 — Оптимизация:** S‑кривые, стратегия уровней, минимизация разворотов.

---
